<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>- · DataCurator Documentation</title><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="index.html"><img src="assets/logo.png" alt="DataCurator Documentation logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">DataCurator Documentation</a></span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Index</a></li><li><a class="tocitem" href="installation.html">Installation</a></li><li><a class="tocitem" href="documented_recipe.html">Documented recipe with all features</a></li><li><a class="tocitem" href="reference.html">API Reference</a></li><li><a class="tocitem" href="conditions.html">Conditions and Actions for use in recipes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="usage.html">-</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="usage.html">-</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/bencardoen/DataCurator.jl/blob/master/docs/src/usage.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h2 id="Usage"><a class="docs-heading-anchor" href="#Usage">Usage</a><a id="Usage-1"></a><a class="docs-heading-anchor-permalink" href="#Usage" title="Permalink"></a></h2><ul><li class="no-marker"><ul><li><a href="usage.html#Usage">Usage</a></li><li><a href="usage.html#Using-recipes-only">Using recipes only</a></li><li><a href="usage.html#Recipes-Julia">Recipes + Julia</a></li><li><a href="usage.html#Using-the-Julia-API-a-name&quot;julia&quot;/a">Using the Julia API &lt;a name=&quot;julia&quot;&gt;&lt;/a&gt;</a></li><li class="no-marker"><ul><li><a href="usage.html#Typesafe-templates">Typesafe templates</a></li><li><a href="usage.html#Examples">Examples</a></li><li class="no-marker"><ul><li><a href="usage.html#Replace-whitespace-and-uppercase">Replace whitespace and uppercase</a></li><li><a href="usage.html#Flatten-a-file-hierarchy">Flatten a file hierarchy</a></li><li><a href="usage.html#Extract-all-3D-tif-files-to-a-single-directory">Extract all 3D tif files to a single directory</a></li><li><a href="usage.html#Sort-2D-image-and-csv-files-into-separate-directories">Sort 2D image and csv files into separate directories</a></li><li><a href="usage.html#Compute-size-in-bytes-of-a-large-hierarchy-in-parallel">Compute size in bytes of a large hierarchy in parallel</a></li><li><a href="usage.html#Compute-size-of-2-vs-3D-images-separately">Compute size of 2 vs 3D images separately</a></li><li><a href="usage.html#Hierarchical-recipes">Hierarchical recipes</a></li><li class="no-marker"><ul><li><a href="usage.html#Create-a-hierarchical-template">Create a hierarchical template</a></li><li><a href="usage.html#First,-define-what-to-do-with-unexpected-directories/files">First, define what to do with unexpected directories/files</a></li><li><a href="usage.html#At-root,-we-only-expect-sub-directories">At root, we only expect sub directories</a></li><li><a href="usage.html#Replicate-should-be-integer">Replicate should be integer</a></li><li><a href="usage.html#Celltype-should-only-be-subdirs">Celltype should only be subdirs</a></li><li><a href="usage.html#Lowest-data-directory-should-end-with-cell-nr,-and-have-2-or-more-files">Lowest data directory should end with cell nr, and have 2 or more files</a></li><li><a href="usage.html#Actual-files-should-be-3D-images">Actual files should be 3D images</a></li><li><a href="usage.html#Execute">Execute</a></li><li class="no-marker"><ul><li><a href="usage.html#Advanced">Advanced</a></li></ul></li></ul></li></ul></li></ul></li><li><a href="usage.html#Fire-triggers-when-they-are-true,-not-when-they-fail">Fire triggers when they are true, not when they fail</a></li><li class="no-marker"><ul><li><a href="usage.html#Parallel-execution">Parallel execution</a></li></ul></li></ul></li></ul><h2 id="Using-recipes-only"><a class="docs-heading-anchor" href="#Using-recipes-only">Using recipes only</a><a id="Using-recipes-only-1"></a><a class="docs-heading-anchor-permalink" href="#Using-recipes-only" title="Permalink"></a></h2><pre><code class="language-bash hljs">./DataCurator.sif -r myrecipe.toml [---verbose]</code></pre><p>or a bit more advanced:</p><pre><code class="language-bash hljs">singularity exec DataCurator.sif julia --project=/opt/DataCurator.jl --sysimage /opt/DataCurator.jl/sys_img.so /opt/DataCurator.jl/src/curator.jl --recipe myrecipe.toml</code></pre><p>You can see why we made the executable image with the very short command, right?</p><p>However, it can be useful to explore the package more inside the singularity image</p><pre><code class="language-bash hljs">singularity exec DataCurator.sif julia &lt;your script&gt;</code></pre><p>You can also open a shell inside the image</p><pre><code class="language-bash hljs">singularity shell DataCurator.sif
singularity&gt;julia
julia 1.x&gt;</code></pre><h2 id="Recipes-Julia"><a class="docs-heading-anchor" href="#Recipes-Julia">Recipes + Julia</a><a id="Recipes-Julia-1"></a><a class="docs-heading-anchor-permalink" href="#Recipes-Julia" title="Permalink"></a></h2><p>Either run this in the image, or with the package</p><pre><code class="language-julia hljs">using DataCurator
result = create_template_from_toml(&quot;recipe.toml&quot;)
if ~isnothing(result) # result will be nothing if something went wrong creating your template
  c, t = res
  counters, lists, returnvalue = delegate(c, t)
end</code></pre><p>You can next iterate over the counters or lists, if needed. Note that aggregation operations at that point have completed.</p><pre><code class="language-julia hljs">for counter in counters
    @info counter
end</code></pre><p>See the API reference for full details.</p><h2 id="Using-the-Julia-API-a-name&quot;julia&quot;/a"><a class="docs-heading-anchor" href="#Using-the-Julia-API-a-name&quot;julia&quot;/a">Using the Julia API &lt;a name=&quot;julia&quot;&gt;&lt;/a&gt;</a><a id="Using-the-Julia-API-a-name&quot;julia&quot;/a-1"></a><a class="docs-heading-anchor-permalink" href="#Using-the-Julia-API-a-name&quot;julia&quot;/a" title="Permalink"></a></h2><p>When you can write Julia you can do anything the template recipes allow and extend it with your own functions, compile more complex functions, and so forth. In this section we&#39;ll walk you through how to do this.</p><h3 id="Typesafe-templates"><a class="docs-heading-anchor" href="#Typesafe-templates">Typesafe templates</a><a id="Typesafe-templates-1"></a><a class="docs-heading-anchor-permalink" href="#Typesafe-templates" title="Permalink"></a></h3><p>We heavily use Julia&#39;s multiple type dispatch system, so when you make a template</p><pre><code class="language-julia hljs">template = [mt(is_tif_file, show_warning)]</code></pre><p>it is internally transformed to a named tuple</p><pre><code class="language-julia hljs">template[1].condition == is_tif_file # true
template[1].action == show_warning</code></pre><p>As a user this may not be relevant to you, but it does help in simplifying the code and optimizing the execution quite dramatically. The Julia compiler for example knows the difference at compile time between</p><pre><code class="nohighlight hljs">fs = [is_tif_file, show_warning, quit]
A = mt(fs...) # condition, action, counteraction
fs = [is_tif_file, show_warning]
B = mt(fs...) # condition, action</code></pre><p>A and B are resolved at compile time, not at runtime, improving execution speed while ensuring type safety.</p><p>To put it differently, your template is usually precompiled, not interpreted, as it would be in bash/Python scripts.</p><h3 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h3><h4 id="Replace-whitespace-and-uppercase"><a class="docs-heading-anchor" href="#Replace-whitespace-and-uppercase">Replace whitespace and uppercase</a><a id="Replace-whitespace-and-uppercase-1"></a><a class="docs-heading-anchor-permalink" href="#Replace-whitespace-and-uppercase" title="Permalink"></a></h4><p>Rename all files/directories with &#39; &#39; in them to &#39;_&#39; and switch any uppercase to lowercase.</p><pre><code class="language-julia hljs">condition = x -&gt; is_upper(x) | has_whitespace(x)
fix = x -&gt; whitespace_to(lowercase(x), &#39;_&#39;)
action = x -&gt; transform_inplace(x, fix)
transform_template(rootdirectory, [mt(condition, action)]; act_on_success=true)</code></pre><p>Next, we verify our dataset has no uppercase/whitespace in names.</p><pre><code class="language-julia hljs">count, counter = generate_counter()
verify_template(rootdirectory, [mt(condition, counter)]; act_on_success=true)
@info count</code></pre><h4 id="Flatten-a-file-hierarchy"><a class="docs-heading-anchor" href="#Flatten-a-file-hierarchy">Flatten a file hierarchy</a><a id="Flatten-a-file-hierarchy-1"></a><a class="docs-heading-anchor-permalink" href="#Flatten-a-file-hierarchy" title="Permalink"></a></h4><pre><code class="language-julia hljs">action = x-&gt;flatten_to(root, x, newdirectory)
verify_template(root, [mt(isfile, action)]; act_on_success=true)</code></pre><h4 id="Extract-all-3D-tif-files-to-a-single-directory"><a class="docs-heading-anchor" href="#Extract-all-3D-tif-files-to-a-single-directory">Extract all 3D tif files to a single directory</a><a id="Extract-all-3D-tif-files-to-a-single-directory-1"></a><a class="docs-heading-anchor-permalink" href="#Extract-all-3D-tif-files-to-a-single-directory" title="Permalink"></a></h4><p>Note, this will halt if the images it extracts exist on the target directory.</p><pre><code class="language-julia hljs">trigger = x-&gt; is_3d_img(x)
action = x-&gt;flatten_to(root, x, image_directory)
verify_template(root, [mt(trigger, action)]; act_on_success=true)</code></pre><h4 id="Sort-2D-image-and-csv-files-into-separate-directories"><a class="docs-heading-anchor" href="#Sort-2D-image-and-csv-files-into-separate-directories">Sort 2D image and csv files into separate directories</a><a id="Sort-2D-image-and-csv-files-into-separate-directories-1"></a><a class="docs-heading-anchor-permalink" href="#Sort-2D-image-and-csv-files-into-separate-directories" title="Permalink"></a></h4><pre><code class="language-julia hljs">img_action = x-&gt;flatten_to(root, x, image_directory)
csv_action = x-&gt;flatten_to(root, x, csv_directory)
verify_template(root, [(mtis_2d_img, img_action), (is_csv_file, csv_action)]; act_on_success=true)</code></pre><h4 id="Compute-size-in-bytes-of-a-large-hierarchy-in-parallel"><a class="docs-heading-anchor" href="#Compute-size-in-bytes-of-a-large-hierarchy-in-parallel">Compute size in bytes of a large hierarchy in parallel</a><a id="Compute-size-in-bytes-of-a-large-hierarchy-in-parallel-1"></a><a class="docs-heading-anchor-permalink" href="#Compute-size-in-bytes-of-a-large-hierarchy-in-parallel" title="Permalink"></a></h4><pre><code class="language-julia hljs">count, counter = generate_size_counter()
verify_template(&quot;rootdirectory&quot;, [mt(isfile, counter)]; act_on_success=true)
@info &quot;Size of matched files = $(count) bytes&quot;</code></pre><h4 id="Compute-size-of-2-vs-3D-images-separately"><a class="docs-heading-anchor" href="#Compute-size-of-2-vs-3D-images-separately">Compute size of 2 vs 3D images separately</a><a id="Compute-size-of-2-vs-3D-images-separately-1"></a><a class="docs-heading-anchor-permalink" href="#Compute-size-of-2-vs-3D-images-separately" title="Permalink"></a></h4><pre><code class="language-julia hljs">count2, counter2 = generate_size_counter()
count3, counter3 = generate_size_counter()
verify_template(&quot;rootdirectory&quot;, [mt(is_2d_img, counter2),(is_3d_img, counter3)]; act_on_success=true)
@info &quot;$(count2) bytes of 2D images, $(count3) of 3D images&quot;</code></pre><h4 id="Hierarchical-recipes"><a class="docs-heading-anchor" href="#Hierarchical-recipes">Hierarchical recipes</a><a id="Hierarchical-recipes-1"></a><a class="docs-heading-anchor-permalink" href="#Hierarchical-recipes" title="Permalink"></a></h4><p>Suppose your data is supposed to have this layout</p><ul><li>root<ul><li>replicate nr<ul><li>celltype<ul><li>cell nr : of the form &quot;Series XYZ&quot;<ul><li>2 tif files, 3D, ending with 1,2.tif</li></ul></li></ul></li></ul></li></ul></li></ul><p>You can use <strong>hierarchical</strong> templates, that give you very precise control of where a condition fires</p><h5 id="Create-a-hierarchical-template"><a class="docs-heading-anchor" href="#Create-a-hierarchical-template">Create a hierarchical template</a><a id="Create-a-hierarchical-template-1"></a><a class="docs-heading-anchor-permalink" href="#Create-a-hierarchical-template" title="Permalink"></a></h5><pre><code class="language-julia hljs">onfail = x-&gt;show_warning
template = Dict()</code></pre><h5 id="First,-define-what-to-do-with-unexpected-directories/files"><a class="docs-heading-anchor" href="#First,-define-what-to-do-with-unexpected-directories/files">First, define what to do with unexpected directories/files</a><a id="First,-define-what-to-do-with-unexpected-directories/files-1"></a><a class="docs-heading-anchor-permalink" href="#First,-define-what-to-do-with-unexpected-directories/files" title="Permalink"></a></h5><pre><code class="language-julia hljs">template[-1] = [mt(never, onfail)]</code></pre><p><em>never</em> is a shortcode symbol for &#39;will never pass&#39;</p><h5 id="At-root,-we-only-expect-sub-directories"><a class="docs-heading-anchor" href="#At-root,-we-only-expect-sub-directories">At root, we only expect sub directories</a><a id="At-root,-we-only-expect-sub-directories-1"></a><a class="docs-heading-anchor-permalink" href="#At-root,-we-only-expect-sub-directories" title="Permalink"></a></h5><pre><code class="language-julia hljs">template[1] = [mt(isdir, onfail)]</code></pre><h5 id="Replicate-should-be-integer"><a class="docs-heading-anchor" href="#Replicate-should-be-integer">Replicate should be integer</a><a id="Replicate-should-be-integer-1"></a><a class="docs-heading-anchor-permalink" href="#Replicate-should-be-integer" title="Permalink"></a></h5><pre><code class="language-julia hljs">template[2] = [mt(x-&gt;all_of(x, [isdir, integer_name]), onfail)]</code></pre><h5 id="Celltype-should-only-be-subdirs"><a class="docs-heading-anchor" href="#Celltype-should-only-be-subdirs">Celltype should only be subdirs</a><a id="Celltype-should-only-be-subdirs-1"></a><a class="docs-heading-anchor-permalink" href="#Celltype-should-only-be-subdirs" title="Permalink"></a></h5><pre><code class="language-julia hljs">template[3] = [mt(isdir, onfail)]</code></pre><h5 id="Lowest-data-directory-should-end-with-cell-nr,-and-have-2-or-more-files"><a class="docs-heading-anchor" href="#Lowest-data-directory-should-end-with-cell-nr,-and-have-2-or-more-files">Lowest data directory should end with cell nr, and have 2 or more files</a><a id="Lowest-data-directory-should-end-with-cell-nr,-and-have-2-or-more-files-1"></a><a class="docs-heading-anchor-permalink" href="#Lowest-data-directory-should-end-with-cell-nr,-and-have-2-or-more-files" title="Permalink"></a></h5><pre><code class="language-julia hljs">inputdir_check = x-&gt;all_of(x, [isdir, x-&gt;ends_with_integer(x), x-&gt;n_files_or_more(x, 2)])
template[4] = [mt(inputdir_check, onfail)]</code></pre><h5 id="Actual-files-should-be-3D-images"><a class="docs-heading-anchor" href="#Actual-files-should-be-3D-images">Actual files should be 3D images</a><a id="Actual-files-should-be-3D-images-1"></a><a class="docs-heading-anchor-permalink" href="#Actual-files-should-be-3D-images" title="Permalink"></a></h5><pre><code class="language-julia hljs">file_check = x -&gt; is_tif_file(x) &amp; is_3d_img(x) &amp; endswith(x, r&quot;[1,2].tif&quot;)
template[5] = [mt(file_check, onfail)]</code></pre><h5 id="Execute"><a class="docs-heading-anchor" href="#Execute">Execute</a><a id="Execute-1"></a><a class="docs-heading-anchor-permalink" href="#Execute" title="Permalink"></a></h5><pre><code class="language-julia hljs">verify_template(root, template; traversalpolicy=topdown, parallel_policy=&quot;parallel&quot;)</code></pre><h6 id="Advanced"><a class="docs-heading-anchor" href="#Advanced">Advanced</a><a id="Advanced-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced" title="Permalink"></a></h6><p>You are free to define even more complex actions, for example, triggers that fire on invalid data AND valid data in 1 template. For example, let&#39;s say we expect csv files, and if we find tif files, then we delete those, otherwise we just warn.</p><pre><code class="language-julia hljs">template[y] = [mt(x-&gt;~is_tif_file(x), delete_file), mt(is_csv_file, onfail)]</code></pre><h2 id="Fire-triggers-when-they-are-true,-not-when-they-fail"><a class="docs-heading-anchor" href="#Fire-triggers-when-they-are-true,-not-when-they-fail">Fire triggers when they are true, not when they fail</a><a id="Fire-triggers-when-they-are-true,-not-when-they-fail-1"></a><a class="docs-heading-anchor-permalink" href="#Fire-triggers-when-they-are-true,-not-when-they-fail" title="Permalink"></a></h2><p>If it&#39;s hard to define conditions that should succeed, you can reverse the firing conditions, but more easily readable is just asking the verifier to do so for you</p><pre><code class="language-julia hljs">verify_template(root, template; act_on_succes=true)</code></pre><h3 id="Parallel-execution"><a class="docs-heading-anchor" href="#Parallel-execution">Parallel execution</a><a id="Parallel-execution-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-execution" title="Permalink"></a></h3><p>All recipes can be executed in parallel. Counters are protected so they are threadsafe, yet need no locks.</p><pre><code class="language-julia hljs">count, counter = generate_counter(true; incrementer=size_of_file)
verify_template(&quot;rootdirectory&quot;, [mt(condition, counter)]; parallel_policy=&quot;parallel&quot;, act_on_success=true)
@info &quot;Size of matched files = $(count) bytes&quot;</code></pre></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.22 on <span class="colophon-date" title="Wednesday 26 October 2022 14:25">Wednesday 26 October 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
